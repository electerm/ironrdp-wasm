<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronRDP Web Client</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header bar */
        #header {
            background: #16213e;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #0f3460;
            flex-shrink: 0;
        }
        #header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #e94560;
            margin-right: 16px;
        }
        #header input {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #0f3460;
            background: #1a1a2e;
            color: #e0e0e0;
            font-size: 13px;
            width: 140px;
        }
        #header input::placeholder { color: #666; }
        #header button {
            padding: 6px 16px;
            border-radius: 4px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        #connect-btn {
            background: #e94560;
            color: white;
        }
        #connect-btn:hover { background: #c73e54; }
        #connect-btn:disabled { background: #555; cursor: not-allowed; }
        #disconnect-btn {
            background: #533483;
            color: white;
        }
        #disconnect-btn:hover { background: #6b44a0; }
        #disconnect-btn:disabled { background: #333; cursor: not-allowed; }

        /* Status indicator */
        #status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }
        .status-disconnected { background: #4a1a1a; color: #f44336; }
        .status-connecting { background: #3a3a1a; color: #ffc107; }
        .status-connected { background: #1a472a; color: #4caf50; }

        /* Canvas area */
        #canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #000;
        }
        #rdp-screen {
            display: block;
            background: #000;
            outline: none;
        }

        /* Log panel */
        #log-panel {
            background: #0d1117;
            border-top: 1px solid #0f3460;
            max-height: 180px;
            overflow-y: auto;
            padding: 8px 12px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            flex-shrink: 0;
        }
        .log-entry { white-space: pre-wrap; word-break: break-all; }
        .log-info { color: #8b949e; }
        .log-success { color: #3fb950; }
        .log-error { color: #f85149; }
        .log-warn { color: #d29922; }
        .log-time { color: #6e7681; margin-right: 6px; }

        /* Fullscreen button */
        #fullscreen-btn {
            background: transparent;
            color: #8b949e;
            border: 1px solid #30363d;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        #fullscreen-btn:hover { background: #30363d; color: #e0e0e0; }
    </style>
</head>
<body>
    <div id="header">
        <h1>IronRDP</h1>
        <input type="text" id="host" placeholder="Host" value="192.168.2.31:3389">
        <input type="text" id="username" placeholder="Username" value="zxd">
        <input type="password" id="password" placeholder="Password" value="zxd">
        <button id="connect-btn">Connect</button>
        <button id="disconnect-btn" disabled>Disconnect</button>
        <button id="fullscreen-btn" title="Toggle fullscreen">⛶</button>
        <span id="status" class="status-disconnected">Disconnected</span>
    </div>

    <div id="canvas-container">
        <canvas id="rdp-screen" width="1280" height="720" tabindex="0"></canvas>
    </div>

    <div id="log-panel"></div>

    <script type="module">
        // ── Import IronRDP WASM module ──
        import init, {
            setup,
            SessionBuilder,
            DesktopSize,
            InputTransaction,
            DeviceEvent,
            Extension,
        } from '../pkg/rdp_client.js';

        // ── DOM Elements ──
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log-panel');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const hostInput = document.getElementById('host');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const canvas = document.getElementById('rdp-screen');
        const canvasContainer = document.getElementById('canvas-container');

        let session = null;
        let wasmInitialized = false;

        // ── Logging ──
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">${time}</span>${escapeHtml(message)}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function setStatus(text, state) {
            statusEl.textContent = text;
            statusEl.className = `status-${state}`;
        }

        // ── Scancode mapping (JS KeyboardEvent.code → PS/2 Set 1 scancode) ──
        // IronRDP expects PS/2 Set 1 scancodes (make codes).
        const SCANCODE_MAP = {
            'Escape': 0x01, 'Digit1': 0x02, 'Digit2': 0x03, 'Digit3': 0x04,
            'Digit4': 0x05, 'Digit5': 0x06, 'Digit6': 0x07, 'Digit7': 0x08,
            'Digit8': 0x09, 'Digit9': 0x0A, 'Digit0': 0x0B, 'Minus': 0x0C,
            'Equal': 0x0D, 'Backspace': 0x0E, 'Tab': 0x0F,
            'KeyQ': 0x10, 'KeyW': 0x11, 'KeyE': 0x12, 'KeyR': 0x13,
            'KeyT': 0x14, 'KeyY': 0x15, 'KeyU': 0x16, 'KeyI': 0x17,
            'KeyO': 0x18, 'KeyP': 0x19, 'BracketLeft': 0x1A, 'BracketRight': 0x1B,
            'Enter': 0x1C, 'ControlLeft': 0x1D,
            'KeyA': 0x1E, 'KeyS': 0x1F, 'KeyD': 0x20, 'KeyF': 0x21,
            'KeyG': 0x22, 'KeyH': 0x23, 'KeyJ': 0x24, 'KeyK': 0x25,
            'KeyL': 0x26, 'Semicolon': 0x27, 'Quote': 0x28, 'Backquote': 0x29,
            'ShiftLeft': 0x2A, 'Backslash': 0x2B,
            'KeyZ': 0x2C, 'KeyX': 0x2D, 'KeyC': 0x2E, 'KeyV': 0x2F,
            'KeyB': 0x30, 'KeyN': 0x31, 'KeyM': 0x32, 'Comma': 0x33,
            'Period': 0x34, 'Slash': 0x35, 'ShiftRight': 0x36,
            'NumpadMultiply': 0x37, 'AltLeft': 0x38, 'Space': 0x39,
            'CapsLock': 0x3A,
            'F1': 0x3B, 'F2': 0x3C, 'F3': 0x3D, 'F4': 0x3E,
            'F5': 0x3F, 'F6': 0x40, 'F7': 0x41, 'F8': 0x42,
            'F9': 0x43, 'F10': 0x44,
            'NumLock': 0x45, 'ScrollLock': 0x46,
            'Numpad7': 0x47, 'Numpad8': 0x48, 'Numpad9': 0x49,
            'NumpadSubtract': 0x4A, 'Numpad4': 0x4B, 'Numpad5': 0x4C,
            'Numpad6': 0x4D, 'NumpadAdd': 0x4E, 'Numpad1': 0x4F,
            'Numpad2': 0x50, 'Numpad3': 0x51, 'Numpad0': 0x52,
            'NumpadDecimal': 0x53,
            'F11': 0x57, 'F12': 0x58,
            'NumpadEnter': 0xE01C, 'ControlRight': 0xE01D,
            'NumpadDivide': 0xE035, 'PrintScreen': 0xE037,
            'AltRight': 0xE038, 'Home': 0xE047, 'ArrowUp': 0xE048,
            'PageUp': 0xE049, 'ArrowLeft': 0xE04B, 'ArrowRight': 0xE04D,
            'End': 0xE04F, 'ArrowDown': 0xE050, 'PageDown': 0xE051,
            'Insert': 0xE052, 'Delete': 0xE053,
            'MetaLeft': 0xE05B, 'MetaRight': 0xE05C, 'ContextMenu': 0xE05D,
            'Pause': 0xE11D45,
        };

        function getScancode(code) {
            return SCANCODE_MAP[code] ?? null;
        }

        // ── Input handling ──
        function setupInputHandlers() {
            // Prevent default browser behavior for most keys when canvas is focused
            canvas.addEventListener('keydown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!session) return;

                const scancode = getScancode(e.code);
                if (scancode === null) {
                    console.warn('Unknown key code:', e.code);
                    return;
                }

                try {
                    const event = DeviceEvent.keyPressed(scancode);
                    const tx = new InputTransaction();
                    tx.addEvent(event);
                    session.applyInputs(tx);
                } catch (err) {
                    console.error('Key press error:', err);
                }
            });

            canvas.addEventListener('keyup', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!session) return;

                const scancode = getScancode(e.code);
                if (scancode === null) return;

                try {
                    const event = DeviceEvent.keyReleased(scancode);
                    const tx = new InputTransaction();
                    tx.addEvent(event);
                    session.applyInputs(tx);
                } catch (err) {
                    console.error('Key release error:', err);
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!session) return;
                try {
                    const rect = canvas.getBoundingClientRect();
                    // Scale mouse coordinates to match the RDP desktop resolution
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const x = Math.round((e.clientX - rect.left) * scaleX);
                    const y = Math.round((e.clientY - rect.top) * scaleY);

                    const event = DeviceEvent.mouseMove(x, y);
                    const tx = new InputTransaction();
                    tx.addEvent(event);
                    session.applyInputs(tx);
                } catch (err) {
                    // Suppress frequent mouse errors
                }
            });

            canvas.addEventListener('mousedown', (e) => {
                e.preventDefault();
                canvas.focus();
                if (!session) return;
                try {
                    const event = DeviceEvent.mouseButtonPressed(e.button);
                    const tx = new InputTransaction();
                    tx.addEvent(event);
                    session.applyInputs(tx);
                } catch (err) {
                    console.error('Mouse down error:', err);
                }
            });

            canvas.addEventListener('mouseup', (e) => {
                e.preventDefault();
                if (!session) return;
                try {
                    const event = DeviceEvent.mouseButtonReleased(e.button);
                    const tx = new InputTransaction();
                    tx.addEvent(event);
                    session.applyInputs(tx);
                } catch (err) {
                    console.error('Mouse up error:', err);
                }
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (!session) return;
                try {
                    // vertical=true for Y axis scroll, false for X axis
                    if (e.deltaY !== 0) {
                        const amount = e.deltaY > 0 ? -1 : 1;
                        const event = DeviceEvent.wheelRotations(true, amount, 1); // 1 = Line unit
                        const tx = new InputTransaction();
                        tx.addEvent(event);
                        session.applyInputs(tx);
                    }
                    if (e.deltaX !== 0) {
                        const amount = e.deltaX > 0 ? -1 : 1;
                        const event = DeviceEvent.wheelRotations(false, amount, 1);
                        const tx = new InputTransaction();
                        tx.addEvent(event);
                        session.applyInputs(tx);
                    }
                } catch (err) {
                    console.error('Wheel error:', err);
                }
            }, { passive: false });

            // Prevent context menu on right-click
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            log('Input handlers configured (keyboard, mouse, wheel)', 'success');
        }

        // ── Format IronError ──
        function formatError(e) {
            if (e && typeof e === 'object' && '__wbg_ptr' in e) {
                try {
                    const kindNames = {
                        0: 'General', 1: 'WrongPassword', 2: 'LogonFailure',
                        3: 'AccessDenied', 4: 'RDCleanPath', 5: 'ProxyConnect',
                        6: 'NegotiationFailure',
                    };
                    const kind = e.kind ? e.kind() : 'Unknown';
                    const bt = e.backtrace ? e.backtrace() : '';
                    return `[${kindNames[kind] || kind}] ${bt}`;
                } catch (_) {}
            }
            return e?.message || e?.toString() || String(e);
        }

        // ── Connect ──
        async function connect() {
            try {
                const destination = hostInput.value || '192.168.2.31:3389';
                const username = usernameInput.value || 'zxd';
                const password = passwordInput.value || 'zxd';

                // Proxy runs on the same origin (same host & port)
                const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                const proxyAddress = `${wsProtocol}//${location.host}`;

                if (!wasmInitialized) {
                    log('Loading IronRDP WebAssembly module...');
                    await init();
                    setup('info');
                    wasmInitialized = true;
                    log('WASM module initialized', 'success');
                }

                setStatus('Connecting...', 'connecting');
                connectBtn.disabled = true;

                log(`Connecting to ${destination} via proxy ${proxyAddress}`);
                log(`User: ${username}`);

                const desktopSize = new DesktopSize(1280, 720);

                // Disable CredSSP since we don't have a Kerberos/NTLM implementation in WASM
                const enableCredsspExt = new Extension('enable_credssp', true);

                const builder = new SessionBuilder();
                builder.username(username);
                builder.password(password);
                builder.destination(destination);
                builder.proxyAddress(proxyAddress);
                builder.authToken('none');
                builder.desktopSize(desktopSize);
                builder.renderCanvas(canvas);
                builder.extension(enableCredsspExt);

                // Cursor style callback
                builder.setCursorStyleCallbackContext(canvas);
                builder.setCursorStyleCallback(function(style) {
                    canvas.style.cursor = style || 'default';
                });

                log('Initiating RDP connection...');
                session = await builder.connect();

                const ds = session.desktopSize();
                log(`Connected! Desktop: ${ds.width}x${ds.height}`, 'success');
                canvas.width = ds.width;
                canvas.height = ds.height;

                setStatus(`Connected (${ds.width}×${ds.height})`, 'connected');
                disconnectBtn.disabled = false;
                canvas.focus();

                // Run the session event loop
                session.run().then((info) => {
                    log(`Session ended: ${info.reason()}`, 'warn');
                    cleanup();
                }).catch((e) => {
                    log(`Session error: ${formatError(e)}`, 'error');
                    cleanup();
                });

            } catch (e) {
                log(`Connection failed: ${formatError(e)}`, 'error');
                cleanup();
            }
        }

        function cleanup() {
            session = null;
            setStatus('Disconnected', 'disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
        }

        function disconnect() {
            if (session) {
                try {
                    session.shutdown();
                    log('Disconnected by user', 'warn');
                } catch (e) {
                    log(`Disconnect error: ${formatError(e)}`, 'error');
                }
            }
            cleanup();
        }

        // ── Fullscreen ──
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                canvasContainer.requestFullscreen().catch(() => {});
            } else {
                document.exitFullscreen().catch(() => {});
            }
        });

        // ── Wire up buttons ──
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);

        // Allow Enter to connect
        [hostInput, usernameInput, passwordInput].forEach(el => {
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !connectBtn.disabled) connect();
            });
        });

        // ── Initialize ──
        setupInputHandlers();
        log('IronRDP Web Client ready. Click Connect to start.');
    </script>
</body>
</html>
